#!/bin/bash

# Skip if already pushed by this hook
if [ "$SKIP_PRE_PUSH" = "true" ]; then
  exit 0
fi

# Ensure we are on the main branch before bumping version
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" != "main" ]; then
  echo "Version bump only on main branch. Skipping."
  exit 0
fi

# Bump version in package.json
new_version_v=$(npm version minor 2>/dev/null)
if [ $? -ne 0 ]; then
  echo "Version bump failed. Tag may already exist."
  exit 1
fi

if [ -z "$new_version_v" ]; then
  echo "No version tag created. Aborting push."
  exit 1
fi

new_version=${new_version_v#v}

# Commit and tag
git add package.json
git commit -m "bump version to $new_version"
git tag "$new_version_v"

# Push manually, skipping hook
SKIP_PRE_PUSH=true git push origin main
SKIP_PRE_PUSH=true git push origin "$new_version_v"

# Cancel original push
echo "Version bumped and pushed. Cancelling original push."
exit 1
